name: CI

on:
  push:
  pull_request:

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  postgresql-check:
    name: PostgreSQL Check
    runs-on: ubuntu-20.04

    services:
      postgres:
        image: postgres:9.6
        
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: xpdotest

        options: --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5

        ports:
          - "5432:5432"
    
    strategy:
      matrix:
        php-version:
          - 5.6
        deps:
          - highest

    steps:
    - name: Checkout
      uses: actions/checkout@v2

    - name: Install PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ matrix.php-version }}
        extensions: pdo, zip, php_pgsql

    - name: Install dependencies with Composer
      uses: ramsey/composer-install@v1
      with:
        dependency-versions: ${{ matrix.deps }}
      
    - name: Copy properties
      run: cp test/properties.travis.inc.php test/properties.inc.php  

    - name: Run PHPUnit
      run: vendor/bin/phpunit -c ./test/pgsql.phpunit.xml
